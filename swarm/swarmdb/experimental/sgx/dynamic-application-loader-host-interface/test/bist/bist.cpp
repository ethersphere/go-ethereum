#include "jhi.h"
#include "teemanagement.h"

#include <cstdint>
#include <string>
#include <iostream>
#include <cstring>
#include <jhi.h>
#include "dbg.h"

using namespace std;

bool CheckJhiSuccess(JHI_RET status, string step)
{
    if (status != JHI_SUCCESS)
    {
        cout << " " << step << " failed. Status: " << JHIErrorToString(status) << endl;
        return false;
    }
    else
    {
        cout << " Success." << endl;
        return true;
    }
}

bool CheckTeeSuccess(JHI_RET status, string step)
{
	if (status != TEE_STATUS_SUCCESS)
	{
		cout << " " << step << " failed. Status: " << TEEErrorToString(status) << endl;
		return false;
	}
	else
	{
		cout << " Success." << endl;
		return true;
	}
}

#define PROD_APP_ID "00000000000000000000000000000001"
#define PROD_APP_BLOB "\x06\x00\x00\x00\xA1\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x86\x80\x00\x00\x27\x07\x10\x20\xDB\x00\x00\x00\x40\x00\x00\x00\x40\x00\x00\x00\x01\x00\x00\x00\x43\x53\x45\x58\x01\x00\x00\x00\xBD\x2F\xBA\x36\xA2\xD6\x4D\xAB\x93\x90\xFF\x6D\xA2\xFE\xF3\x1C\x04\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3D\x3D\x5B\x0C\x54\x4A\xBE\x71\xCE\xF0\x1E\x98\x3F\x1C\x48\x11\xAD\x90\x1D\x73\xA6\x9A\x8F\x90\x6D\xF3\xE0\x35\xB8\xF1\xF5\xC5\x08\x7F\x8B\xAD\x50\x55\xC8\x7C\x0A\xFE\xAD\x5A\xF1\x78\x29\xB8\x49\xA8\x7F\x7B\x9E\x39\xCB\xE8\x0A\x38\x8E\x3D\xE2\x45\x6B\x4C\x58\x34\xDC\x9B\x8F\x8F\x5B\xDD\x16\x12\x19\xC1\x17\x25\x8F\x72\xDD\xCD\x0F\xE2\x33\x0F\x1D\x7E\x50\x45\xB4\x6B\x69\xE4\x8E\x22\xD5\x95\x99\xB2\xCC\x6F\xCB\xB1\x19\xE7\x80\x07\x5F\x64\x4C\x3C\x8B\xE0\x06\x91\x56\x98\x52\x77\x29\x0F\x52\x45\x16\xC0\x39\x3A\x83\x27\xD3\x54\x9D\x65\x59\x09\x80\x16\xBF\x16\x9D\x7A\x48\x95\x62\x40\xEB\xA8\x79\x77\x83\xC8\x14\x33\x24\x8D\xA1\x50\x6D\x16\xA1\x88\xC0\x52\x0D\x01\x36\xEA\xEC\x84\x5D\x3F\xB0\xDC\x83\xAB\x92\x82\x8F\x64\x17\xAB\x18\x5E\x0C\xDC\x2D\x2E\x3A\xD0\x5B\x40\x60\x80\x06\x5B\x07\x89\x9B\x93\xB6\x00\xE1\xC9\x31\x6B\xD8\x38\x4C\x67\xBB\xDA\x1C\xDA\xBD\x53\x0D\x2B\xFB\xFA\x66\xE1\x35\xC6\x1B\x1F\xE6\x92\x9D\x59\xF5\x25\x42\xA7\x4A\xA0\xE8\x47\x7B\x23\x3D\x77\x4D\x42\x92\x98\x27\x62\xE7\xD6\xED\x9C\xFE\x12\x91\xD6\x01\x00\x01\x00\xF8\xF8\x16\x0C\x78\x51\x5D\x25\xD2\x45\x5F\xDE\x76\x4B\x63\xC6\xAE\xA0\x1E\xDC\xE3\x16\x19\x3C\x36\xE8\x30\x37\x38\x04\x55\x70\xC5\xA4\x3F\x70\xA3\xBA\xB7\x6E\x61\xD3\x9D\xCE\x1D\xFE\x69\x9B\x86\x37\x2B\x63\x4A\x78\x68\x9C\xE6\x6B\x68\x58\x6A\x3B\xD2\xCA\x00\x6C\x6C\x54\x03\xFF\xBD\xE8\x37\x8D\x00\x15\x4E\x1E\x74\x9B\xE2\x8F\x45\x55\x8B\x64\xF9\x2B\x62\x9C\x3C\xBB\x5A\xD3\x72\x4D\xE0\x2E\x51\xCD\x61\x0B\xD5\xB1\x88\x69\x05\x68\x12\xA5\x4C\x09\x36\x4D\xE1\xFB\xD1\x1B\x81\xEB\x84\x8F\xAF\x3F\xAA\xAD\xD1\x4E\x40\xB9\x36\x1D\x1B\x3E\x9E\xE4\x87\xA1\x35\x66\xFB\x92\x7F\xC1\xC5\x20\x31\x87\x99\x92\x63\x65\x58\xD8\x23\xBC\xBF\x3F\xF5\xC9\x8E\xA9\xB1\x9D\xB6\x4D\x7B\x2A\xBB\x8F\xB5\x9F\x47\xF5\x3E\xBF\xCA\xF5\x7A\x8C\xAA\x88\x80\x9F\xD0\xFE\x30\xA4\x81\x2E\x08\x7C\x76\x56\xDE\xE9\x78\xA0\x59\x0A\x19\xE3\x4F\x8D\x37\x2A\x50\xC0\x4D\x17\xAC\xB0\xE6\xCE\xE4\x8F\xFB\xF7\xCE\xDB\x54\x56\xC8\x3D\xFC\x27\xE7\x5D\x8B\xF0\xD4\xC4\x80\x75\xA2\x65\xB8\x92\x5E\xD6\x79\x21\xC6\x3E\xD6\x9D\x87\x88\x9E\x2D\x14\xB9\xF9\x33\x07\x8F\x00\x00\x00\x00\x42\x41\x43\x50\x01\x00\x00\x00\xE4\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x20\x00\x00\x00\xAC\x00\x00\x00\x05\x00\x00\x00\x81\x00\x00\x00\x69\x6E\x74\x00\x73\x65\x63\x75\x72\x69\x74\x79\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x31\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x34\x2E\x31\x39\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x70\x6C\x61\x74\x66\x6F\x72\x6D\x00\x43\x53\x45\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x6C\x69\x62\x72\x61\x72\x79\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x31\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x61\x70\x69\x2E\x6C\x65\x76\x65\x6C\x00\x37\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x01\x00\x00\x00\x02\x00\x00\x00\x6E\x0B\x49\x95\xD0\xA6\x19\xD7\xD2\x5B\x14\x08\x0E\xAE\x0F\xDC\x24\x30\x6C\xDD\xC1\xF3\x2A\x87\x0D\x87\x68\x51\xA6\xBF\xF0\x60\xDD\xDD\xDD\xDD\x20\x4E\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xE8\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0D\x00\x00\x00\xCC\x01\x00\x00\x69\x6E\x74\x00\x73\x65\x63\x75\x72\x69\x74\x79\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x31\x00\x62\x6F\x6F\x6C\x00\x61\x70\x70\x6C\x65\x74\x2E\x77\x72\x69\x74\x74\x65\x6E\x2E\x62\x79\x2E\x69\x6E\x74\x65\x6C\x00\x74\x72\x75\x65\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x34\x2E\x31\x39\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x76\x65\x6E\x64\x6F\x72\x00\x49\x6E\x74\x65\x6C\x20\x43\x6F\x72\x70\x6F\x72\x61\x74\x69\x6F\x6E\x00\x62\x6F\x6F\x6C\x00\x61\x70\x70\x6C\x65\x74\x2E\x73\x68\x61\x72\x65\x64\x2E\x73\x65\x73\x73\x69\x6F\x6E\x2E\x73\x75\x70\x70\x6F\x72\x74\x00\x66\x61\x6C\x73\x65\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x70\x6C\x61\x74\x66\x6F\x72\x6D\x00\x43\x53\x45\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x6E\x61\x6D\x65\x00\x42\x69\x73\x74\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x6C\x69\x62\x72\x61\x72\x79\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x31\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x66\x6C\x61\x73\x68\x2E\x71\x75\x6F\x74\x61\x00\x30\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x65\x6E\x74\x72\x79\x5F\x63\x6C\x61\x73\x73\x00\x63\x6F\x6D\x2E\x69\x6E\x74\x65\x6C\x2E\x61\x70\x70\x73\x2E\x62\x69\x73\x74\x50\x61\x63\x6B\x61\x67\x65\x2E\x42\x69\x73\x74\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x64\x65\x73\x63\x72\x69\x70\x74\x69\x6F\x6E\x00\x49\x6E\x74\x65\x6C\x28\x52\x29\x20\x44\x79\x6E\x61\x6D\x69\x63\x20\x41\x70\x70\x6C\x69\x63\x61\x74\x69\x6F\x6E\x20\x4C\x6F\x61\x64\x65\x72\x20\x74\x65\x73\x74\x20\x61\x70\x70\x6C\x69\x63\x61\x74\x69\x6F\x6E\x00\x62\x6F\x6F\x6C\x00\x61\x70\x70\x6C\x65\x74\x2E\x64\x65\x62\x75\x67\x2E\x65\x6E\x61\x62\x6C\x65\x00\x66\x61\x6C\x73\x65\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x61\x70\x69\x2E\x6C\x65\x76\x65\x6C\x00\x37\x00\x00\x00\x00\x00\xDD\xDD\xDD\xDD\x4A\x45\x46\x46\x01\x00\x00\x00\x78\x05\x00\x00\x00\x00\x04\x00\x01\x00\x04\x00\x0A\x00\x00\x00\x08\x00\x00\x00\x50\x02\x00\x00\xEC\x02\x00\x00\xA4\x03\x00\x00\x00\x00\x00\x00\x30\x00\x00\x00\x22\x00\x00\x00\x21\x00\x00\x00\xCC\x00\x00\x00\x28\x00\xA4\x00\x00\x00\xD8\x00\x1E\x00\xF2\x01\x24\x00\x00\x00\xA8\x00\x04\x00\x03\x00\x00\x00\x02\x00\x01\x00\x0A\x00\x00\x00\x00\x00\x00\x00\x22\x00\x02\x00\x1A\x00\xF8\x01\x01\x00\x00\x00\x22\x00\x02\x00\x1A\x00\xFC\x01\x02\x00\x00\x00\x22\x00\x02\x00\x1A\x00\x00\x02\x03\x00\x00\x00\x22\x00\x02\x00\x1A\x00\x04\x02\x04\x00\x00\x00\x22\x00\x02\x00\x1A\x00\x04\x02\x05\x00\x00\x00\x22\x00\x64\x01\x1A\x00\x00\x00\x06\x00\x00\x00\x22\x00\x02\x00\x1A\x00\x08\x02\x07\x00\x00\x00\x22\x00\x02\x00\x1A\x00\x00\x02\x08\x00\x00\x00\x22\x00\x64\x01\x1A\x00\x00\x00\x09\x00\x00\x00\x22\x00\x02\x00\x1A\x00\x0C\x02\x04\x00\x00\x00\x01\x00\x00\x00\x22\x00\x01\x00\x01\x00\x04\x01\x02\x00\x00\x00\x22\x00\x01\x00\x02\x00\x12\x01\x03\x00\x00\x00\x22\x00\x03\x00\x01\x00\x52\x01\x00\x00\x00\x00\x22\x00\x00\x00\x08\x00\xCA\x01\x05\x00\x00\x00\x01\x00\x00\x00\x24\x00\x00\x00\x07\x00\x00\x00\x22\x00\x00\x00\x06\x00\x00\x00\x26\x00\x00\x00\x05\x00\x00\x00\x26\x00\x00\x00\x04\x00\x00\x00\x26\x00\x00\x00\x01\x00\x01\x00\x00\x00\x05\x00\x2A\xB7\xDC\x00\xB1\x00\x05\x00\x04\x00\xE8\x01\x38\x00\x10\x20\xBC\x64\x4D\x10\x20\xBC\x64\x4E\x2C\x03\x10\x20\x10\x08\xB8\x00\xEC\x00\x2C\x03\x2D\x03\x10\x20\xB8\x00\xF4\x00\x2C\x03\x2D\x03\x10\x20\xB8\x00\xFC\x00\x3C\xA7\x49\x01\x4D\x03\x3C\x1B\x99\x00\x50\x01\x03\xAC\x04\xAC\x04\x00\x04\x00\x00\x00\x70\x00\x1B\xCC\xBC\x01\x02\x00\x00\x00\x01\x00\x68\x01\x90\x01\x2A\xB7\xB4\x00\x3E\x1D\x9A\x00\x82\x01\x2A\xB2\x8C\x00\x03\xB2\x8C\x00\xBE\xB6\xE4\x00\xA7\x00\x8E\x01\x2A\xB2\x68\x00\x03\xB2\x68\x00\xBE\xB6\xE4\x00\x1D\xAC\x2C\xC6\xA4\x01\x2C\xBE\x9E\x00\xA4\x01\x2C\xBE\x11\x00\x00\x01\xA4\x00\xB2\x01\x2A\xB2\x68\x00\x03\xB2\x68\x00\xBE\xB6\xE4\x00\x04\xAC\x2A\x2C\x03\x2C\xBE\xB6\xE4\x00\x03\xAC\x2A\xB2\x68\x00\x03\xB2\x68\x00\xBE\xB6\xE4\x00\x05\xAC\x04\x00\x00\x00\x00\x00\x15\x00\xCB\x64\x07\x00\x10\x02\xB3\x00\x8C\x00\xCB\x64\x07\x00\x17\x02\xB3\x00\x68\x00\xB1\x00\x01\x00\x1A\x01\x43\x01\x46\x01\x20\x00\x28\x00\x06\x00\x0E\x00\x20\x00\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x02\x00\x00\x00\x53\x55\x43\x43\x45\x53\x53\x46\x41\x49\x4C\x55\x52\x45\x00\x00\x54\x02\x00\x00\x3E\x05\x00\x00\x78\x02\x00\x00\x00\x00\x00\x00\x7E\x02\x00\x00\x00\x00\x00\x00\xAC\x02\x00\x00\x00\x00\x00\x00\xE2\x02\x00\x00\x00\x00\x00\x00\x01\x00\x0C\x01\x25\x00\x0B\x00\x1A\x01\x63\x00\x1F\x01\x64\x00\x24\x01\x65\x00\x2E\x01\x66\x00\x38\x01\x67\x00\x43\x01\x6B\x00\x46\x01\x69\x00\x47\x01\x6A\x00\x49\x01\x6C\x00\x4E\x01\x6D\x00\x50\x01\x6E\x00\x0D\x00\x5A\x01\x44\x00\x68\x01\x47\x00\x6D\x01\x48\x00\x72\x01\x49\x00\x82\x01\x4B\x00\x8E\x01\x4C\x00\x90\x01\x4F\x00\xA4\x01\x50\x00\xB0\x01\x51\x00\xB2\x01\x53\x00\xBA\x01\x54\x00\xBC\x01\x57\x00\xC8\x01\x58\x00\x02\x00\xD2\x01\x35\x00\xDC\x01\x36\x00\x01\x00\x02\x00\x03\x00\x00\x00\xB0\x03\x00\x00\xCC\x03\x00\x00\xE0\x03\x00\x00\xF0\x03\x00\x00\xFC\x03\x00\x00\x02\x04\x00\x00\x0E\x04\x00\x00\x1C\x04\x00\x00\x28\x04\x00\x00\x49\x05\x00\x00\x36\x04\x00\x00\x49\x05\x00\x00\x44\x04\x00\x00\x49\x05\x00\x00\x62\x04\x00\x00\x49\x05\x00\x00\x72\x04\x00\x00\x49\x05\x00\x00\x7C\x04\x00\x00\x4A\x05\x00\x00\x8C\x04\x00\x00\x49\x05\x00\x00\x9E\x04\x00\x00\x49\x05\x00\x00\xA8\x04\x00\x00\x4A\x05\x00\x00\xB8\x04\x00\x00\x49\x05\x00\x00\xC4\x04\x00\x00\x4C\x05\x00\x00\xCE\x04\x00\x00\x4C\x05\x00\x00\xD6\x04\x00\x00\x50\x05\x00\x00\xEE\x04\x00\x00\x54\x05\x00\x00\xFE\x04\x00\x00\x5A\x05\x00\x00\x10\x05\x00\x00\x62\x05\x00\x00\x20\x05\x00\x00\x6A\x05\x00\x00\x30\x05\x00\x00\x72\x05\x00\x00\x1B\x00\x00\x00\x02\x00\x00\x00\x07\x00\x00\x00\x1A\x00\x63\x6F\x6D\x2E\x69\x6E\x74\x65\x6C\x2E\x61\x70\x70\x73\x2E\x62\x69\x73\x74\x50\x61\x63\x6B\x61\x67\x65\x12\x00\x63\x6F\x6D\x2E\x69\x6E\x74\x65\x6C\x2E\x6C\x61\x6E\x67\x75\x74\x69\x6C\x0E\x00\x63\x6F\x6D\x2E\x69\x6E\x74\x65\x6C\x2E\x75\x74\x69\x6C\x09\x00\x6A\x61\x76\x61\x2E\x6C\x61\x6E\x67\x00\x04\x00\x42\x69\x73\x74\x0A\x00\x41\x72\x72\x61\x79\x55\x74\x69\x6C\x73\x0B\x00\x49\x6E\x74\x65\x6C\x41\x70\x70\x6C\x65\x74\x00\x09\x00\x45\x78\x63\x65\x70\x74\x69\x6F\x6E\x00\x0C\x00\x41\x52\x52\x41\x59\x5F\x4C\x45\x4E\x47\x54\x48\x0C\x00\x43\x4F\x4E\x53\x54\x5F\x4E\x55\x4D\x42\x45\x52\x1C\x00\x43\x4F\x50\x59\x5F\x43\x4F\x4D\x50\x41\x52\x45\x5F\x42\x55\x46\x46\x45\x52\x5F\x54\x45\x53\x54\x5F\x43\x49\x44\x0D\x00\x45\x43\x48\x4F\x5F\x54\x45\x53\x54\x5F\x43\x49\x44\x00\x07\x00\x46\x41\x49\x4C\x55\x52\x45\x00\x0E\x00\x46\x41\x49\x4C\x55\x52\x45\x5F\x42\x55\x46\x46\x45\x52\x10\x00\x4D\x41\x58\x5F\x49\x4E\x50\x55\x54\x5F\x4C\x45\x4E\x47\x54\x48\x07\x00\x53\x55\x43\x43\x45\x53\x53\x00\x0E\x00\x53\x55\x43\x43\x45\x53\x53\x5F\x42\x55\x46\x46\x45\x52\x09\x00\x57\x52\x4F\x4E\x47\x5F\x43\x49\x44\x00\x08\x00\x3C\x63\x6C\x69\x6E\x69\x74\x3E\x06\x00\x3C\x69\x6E\x69\x74\x3E\x15\x00\x63\x6F\x70\x79\x43\x6F\x6D\x70\x61\x72\x65\x42\x75\x66\x66\x65\x72\x54\x65\x73\x74\x00\x0D\x00\x69\x6E\x76\x6F\x6B\x65\x43\x6F\x6D\x6D\x61\x6E\x64\x00\x10\x00\x63\x6F\x6D\x70\x61\x72\x65\x42\x79\x74\x65\x41\x72\x72\x61\x79\x0D\x00\x63\x6F\x70\x79\x42\x79\x74\x65\x41\x72\x72\x61\x79\x00\x0D\x00\x66\x69\x6C\x6C\x42\x79\x74\x65\x41\x72\x72\x61\x79\x00\x0B\x00\x73\x65\x74\x52\x65\x73\x70\x6F\x6E\x73\x65\x00\x09\x00\x42\x69\x73\x74\x2E\x6A\x61\x76\x61\x02\x64\x00\x00\x00\x00\x00\x00\x00\x02\x00\x02\x00\x02\x64\x02\x00\x05\x00\x64\x02\x64\x02\x02\x08\x05\x00\x64\x02\x64\x02\x02\x00\x04\x00\x64\x02\x02\x04\x00\x00\x03\x00\x64\x02\x02\x00"
#define PROD_APP_LEN 2784
#define INTEL_SD_UUID "BD2FBA36A2D64DAB9390FF6DA2FEF31C"
#define TX_LEN 8
#define RX_LEN 8

int main()
{
    JHI_RET status = JHI_UNKNOWN_ERROR;
    JHI_HANDLE jhi_handle = NULL;
    JHI_SESSION_HANDLE app_session_handle = NULL;
	SD_SESSION_HANDLE sd_session_handle = NULL;

    uint8_t txbuf[TX_LEN] = {0};
    uint8_t rxbuf[RX_LEN] = {0};

    JVM_COMM_BUFFER comm_buffer;

    comm_buffer.TxBuf->length = TX_LEN;
    comm_buffer.TxBuf->buffer = txbuf;
    comm_buffer.RxBuf->length = RX_LEN;
    comm_buffer.RxBuf->buffer = rxbuf;

    do
	{
		/*
		 * TEE_Management test
		 */

		// Open an Intel SD session
		cout << "Opening Intel SD session...";
		status = TEE_OpenSDSession(INTEL_SD_UUID, &sd_session_handle);
		if (!CheckTeeSuccess(status, "TEE_OpenSDSession")) break;

		// Install using teemanagement
		cout << "Installing the production BIST applet...";
		status = TEE_SendAdminCmdPkg(sd_session_handle, (uint8_t *)PROD_APP_BLOB, PROD_APP_LEN);
		if (!CheckTeeSuccess(status, "TEE_SendAdminCmdPkg")) break;

		// Close the Intel SD session
		cout << "Closing the Intel SD session...";
		status = TEE_CloseSDSession(&sd_session_handle);
		if (!CheckTeeSuccess(status, "TEE_CloseSDSession")) break;

		/*
		 * JHI lib test
		 */

		// Init
        cout << "Initializing JHI...";
        status = JHI_Initialize(&jhi_handle, 0, 0);
        if (!CheckJhiSuccess(status, "JHI_Initialize")) break;

        // Create a session
        cout << "Creating a session...";
        status = JHI_CreateSession(jhi_handle, PROD_APP_ID, 0, NULL, &app_session_handle);
        if (!CheckJhiSuccess(status, "JHI_CreateSession")) break;

		/*
		 * Functional test
		 */

		// Run the compare buffer test
		cout << "Running the Compare Buffer test...";
		status = JHI_SendAndRecv2(jhi_handle, app_session_handle, 0, &comm_buffer, NULL);
		if (!CheckJhiSuccess(status, "JHI_SendAndRecv2")) break;

		// Make sure the Compare Buffer test passed
		cout << "Making sure the Compare Buffer test passed...";
		if(memcmp("SUCCESS", comm_buffer.RxBuf->buffer, 7)) // not equal
		{
			cout << "Fail.\nCompare Buffer test failed. Received buffer: "<< comm_buffer.RxBuf->buffer << endl;
			status = JHI_UNKNOWN_ERROR;
			break;
		}
		else
			cout << " Success." << endl;

		// Run the echo test
		cout << "Running the Echo test...";
		comm_buffer.RxBuf->length = RX_LEN;
		memcpy(comm_buffer.TxBuf->buffer, "ECHOBUF", 7);
		status = JHI_SendAndRecv2(jhi_handle, app_session_handle, 1, &comm_buffer, NULL);
		if (!CheckJhiSuccess(status, "JHI_SendAndRecv2")) break;

		// Make sure the Echo test passed
		cout << "Making sure the Echo test passed...";
		if(memcmp("ECHOBUF", comm_buffer.RxBuf->buffer, 7)) // not equal
		{
			cout << "\nEcho test failed. Received buffer: "<< comm_buffer.RxBuf->buffer << endl;
			status = JHI_UNKNOWN_ERROR;
			break;
		}
		else
			cout << " Success." << endl;

		/*
		 * Teardown
		 */

        // Close session
        cout << "Closing the session...";
        status = JHI_CloseSession(jhi_handle, &app_session_handle);
        if (!CheckJhiSuccess(status, "JHI_CloseSession")) break;

        // Uninstall
        cout << "Uninstalling...";
        status = JHI_Uninstall(jhi_handle, PROD_APP_ID);
        if (!CheckJhiSuccess(status, "JHI_Uninstall")) break;

        // Deinit
        cout << "Deinitilizing JHI...";
        status = JHI_Deinit(jhi_handle);
        if (!CheckJhiSuccess(status, "JHI_Deinit")) break;
    } while (0);

	return status == JHI_SUCCESS ? 0 : 1;
}

